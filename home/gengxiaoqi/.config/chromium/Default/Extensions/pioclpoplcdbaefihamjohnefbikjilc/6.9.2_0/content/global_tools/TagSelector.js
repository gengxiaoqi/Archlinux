/*! Copyright 2009-2016 Evernote Corporation. All rights reserved. */
function TagSelector(a,b,c){"use strict";function d(){return F.innerText.indexOf("\n")!==-1}function e(){G||(G=new MutationObserver(function(a){a.forEach(function(a){if(a.addedNodes&&a.addedNodes.length>0)for(var b=0;b<a.addedNodes.length;b++){var c=a.addedNodes[b];"FONT"===c.tagName&&c.parentNode.removeChild(c)}})}));var a={childList:!0,subtree:!0};G.observe(F,a)}function f(){G&&G.disconnect()}function g(){var a=document.activeElement===F;return F.innerText="",F.blur(),a}function h(a){j(A,a)}function i(a){j(B,a)}function j(a,b){for(var c=0;c<b.length;c++)for(var d=new Tag(b[c].name),e=b[c].name.split(/\s+/),f=0;f<e.length;f++)if(d.paths.indexOf(e[f])<0&&d.paths.push(e[f]),a.insert(e[f],d),CommonSelector.SPECIAL_CHAR_REGEX.test(e[f])){var g=e[f].replace(CommonSelector.SPECIAL_CHAR_REGEX,"");d.paths.indexOf(g)<0&&d.paths.push(g),a.insert(g,d)}}function k(a){if(void 0!==a&&a.length>y&&(a=a.substr(0,y)),H.children.length<x&&""!==a&&!D[a.toLowerCase()]){var b=document.createElement("div");b.innerText=a;var c=document.createElement("div");c.classList.add("tTag"),c.title=a,b.classList.add("tTagText");var d=document.createElement("div");d.classList.add("tDeleteTag"),d.addEventListener("click",function(){n(this.parentNode)}),c.appendChild(d),c.appendChild(b),H.appendChild(c),H.children.length>=x&&o(z.EXCEEDED_MAX),r(),D[a.toLowerCase()]=1}}function l(a){k(a.trim()),F.innerHTML="",v(null,"")}function m(a){var b=document.createElement("div");b.innerText=a,b.title=a,b.classList.add("tDropdownTag"),b.addEventListener("mouseover",function(){for(var a=I.querySelectorAll(".tHover"),b=0;b<a.length;b++)a[b].classList.remove("tHover");this.classList.add("tHover")}),b.addEventListener("mousedown",function(a){1===a.which&&l(this.innerText),a.preventDefault()}),CommonSelector.binaryInsert(I,function(a){return a.innerText},b),E[a]=1}function n(a){delete D[a.lastElementChild.innerText.toLowerCase()],a.parentNode.removeChild(a),H.children.length<x&&p(),r(),c()}function o(a){F.classList.add("tDisabled"),F.contentEditable="false",a===z.EXCEEDED_MAX?F.classList.add("tMax"):a===z.LINKED_NOTEBOOK&&(F.classList.add("tLinked"),H.style.display="none"),c()}function p(){F.classList.remove("tDisabled","tMax","tLinked"),F.contentEditable="true",H.style.display="",c()}function q(){var a=[];if(!F.classList.contains("tDisabled")||!F.classList.contains("tLinked"))for(var b=0;b<H.children.length;b++)a.push(GlobalUtils.removeControlCharacters(H.children[b].lastElementChild.innerText));return a}function r(){for(var a=0,b=H.children.length-1;b>=0;b--)if(a||(a=H.children[b].offsetTop),H.children[b].offsetTop===a)H.children[b].classList.add("lastRow");else{if(!H.children[b].classList.contains("lastRow"))break;H.children[b].classList.remove("lastRow")}}function s(){F.focus()}function t(a,b){for(var c=a.join(" "),d=0;d<b.length;d++)if(!new RegExp("(\\s|^)"+b[d].replace(/([\\\^\$\.\|\?\*\+\(\)\[\{\]\}])/g,"\\$1"),"i").test(c))return!1;return!0}function u(){A=new Trie,B=new Trie,C=null}function v(a,c){if(I.innerHTML="",E={},a&&""!==c.trim())for(var d=c.split(/\s+/),e=a.getMatching(d[0],75),f=0;f<e.length;f++)for(var g=0;g<e[f][1].length;g++)D[e[f][1][g].name.toLowerCase()]||E[e[f][1][g].name]||!t(e[f][1][g].paths,d)||m(e[f][1][g].name);b()}function w(a){p(),H.children.length>=x&&o(z.EXCEEDED_MAX),a===GlobalUtils.NOTEBOOK_TYPE_PERSONAL?C=A:a===GlobalUtils.NOTEBOOK_TYPE_LINKED?o(z.LINKED_NOTEBOOK):a===GlobalUtils.NOTEBOOK_TYPE_BUSINESS&&(C=B)}var x=20,y=100,z={EXCEEDED_MAX:1,LINKED_NOTEBOOK:2},A=new Trie,B=new Trie,C=null,D={},E={};a.classList.add("tContainer");var F=document.createElement("div");F.classList.add("tInput"),F.dataset.placeholder=Browser.i18n.getMessage("quickNote_addTags"),F.dataset.maxTagsPlaceholder=Browser.i18n.getMessage("tagNamesNotInRange"),F.dataset.linkedPlaceholder=Browser.i18n.getMessage("quickNote_tagsDisabled"),F.tabIndex=3;var G,H=document.createElement("div");H.classList.add("tExisting");var I=document.createElement("div");I.classList.add("tDropdown"),p(),F.addEventListener("input",function(){EDGE?d()&&(F.innerText=F.innerText.replace(/\n/g,"")):(F.innerText=F.innerText,F.innerText=F.innerText.replace(/\n/g,""));var a=F.innerText.split(/\s*,\s*/);if(a.length>1)for(var b=0;b<a.length;b++)l(a[b]);else v(C,F.innerText)}),EDGE&&F.addEventListener("focus",function(){e()}),F.addEventListener("blur",function(){l(F.innerText),EDGE&&setTimeout(f,100)}),F.addEventListener("keydown",function(a){if(EDGE&&d()&&(F.innerText=F.innerText.replace(/\n/g,"")),13===a.keyCode){var b=I.querySelector(".tHover");l(b?b.innerText:F.innerText)}else if(["Up","Down"].indexOf(a.getKeyIdentifier())>=0){var b=I.querySelector(".tHover");if(b){var c=null;c="Up"===a.getKeyIdentifier()?b.previousElementSibling:b.nextElementSibling}else c=I.firstElementChild;c&&(c.classList.add("tHover"),b&&b.classList.remove("tHover"),c.scrollIntoViewIfNeeded?c.scrollIntoViewIfNeeded():c.scrollIntoView()),a.preventDefault()}}),I.addEventListener("mousedown",function(a){a.preventDefault()}),a.appendChild(F),a.appendChild(H),a.appendChild(I),this.abort=g,this.addBusinessTags=i,this.addPersonalTags=h,this.addTagAndClearInput=l,this.focus=s,this.getTags=q,this.reset=u,this.setActiveTrie=w,this.__defineGetter__("height",function(){return I.offsetTop+I.offsetHeight}),Object.preventExtensions(this)}function Tag(a){"use strict";this.name=a,this.paths=[],Object.preventExtensions(this)}Object.preventExtensions(TagSelector),Object.preventExtensions(Tag);