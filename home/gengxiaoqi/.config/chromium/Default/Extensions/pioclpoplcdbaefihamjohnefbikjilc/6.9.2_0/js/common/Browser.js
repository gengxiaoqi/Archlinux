/*! Copyright 2009-2016 Evernote Corporation. All rights reserved. */
function getExtensionID(){return chrome.runtime&&chrome.runtime.id?chrome.runtime.id:chrome.i18n.getMessage("@@extension_id")}function initBrowser(){"use strict";Browser.i18n=chrome.i18n,Browser.extension=chrome.extension,Browser.EVERNOTE_VERSION="6.9.2",Browser.agent=null,Browser.keyCombos={},Browser.currentKeys={},Browser.safariPopoverVisibilityCheckInterval=0,Browser.safariBrowserActionClickHelper=function(){log.log("do nothing on browser action click - default handler")},Browser.safariBrowserActionClickHandler=function(a){Browser.safariBrowserActionClickHelper(a)},Browser.extensionID=getExtensionID(),SAFARI&&safari&&safari.application&&safari.application.addEventListener("command",Browser.safariBrowserActionClickHandler),Browser.browserActionOnClickedListeners=[],Browser.sendToTab=function(a,b,c){if(SAFARI)try{a.page.dispatchMessage(b.name,b)}catch(d){c&&c(d)}else chrome.tabs.sendMessage?chrome.tabs.sendMessage(a.id,b,c):chrome.tabs.sendRequest(a.id,b,c)},Browser.sendToExtension=function(a,b){if(SAFARI)try{safari.self.tab.dispatchMessage(a.name,a)}catch(c){throw console.log("Browser.sendToExtension failed",a.name,c),c}else try{chrome.runtime&&chrome.runtime.sendMessage?b?chrome.runtime.sendMessage(a,b):chrome.runtime.sendMessage(a):chrome.extension&&chrome.extension.sendMessage?chrome.extension.sendMessage(a):chrome.extension.sendRequest(a)}catch(d){if(!b)throw d;b(d)}},Browser.getAgent=function(){if(Browser.agent)return Browser.agent;var a="Unknown/1.0",b=/^Mozilla\/\d+(\.\d+)*\s+\(.*?([^;()]*(Windows|OS X|Linux)[^;()]*).*?\)/i,c=b.exec(navigator.userAgent);c&&c[2]&&(a=c[2].trim()),a=a.replace(/\s+(\S*\d)/,"/$1");var d="Evernote Webclipper/"+Browser.EVERNOTE_VERSION+" ("+navigator.language+"); "+a+"; ",e="0.0";return SAFARI?(e=navigator.userAgent.replace(/^.*Version\/([0-9.]+).*$/,"$1"),e==navigator.userAgent&&(e="0.0"),d+="Safari/"+e):(e=navigator.userAgent.replace(/^.*Chrome\/([0-9.]+).*$/,"$1"),e==navigator.userAgent&&(e="0.0"),d+="Chrome/"+e),d+=";",Browser.agent=d,Browser.agent},Browser.removeMessageHandlers=function(){if(SAFARI){var a=null;a=safari.application?safari.application:safari.self;for(var b=0;b<Browser.messageListeners.length;b++)a.removeEventListener("message",Browser.messageListeners[b],!1),console.log("Removing message listener: "),console.log(Browser.messageListeners[b])}Browser.messageListeners=[]},Browser.addMessageHandlers=function(a,b){var c;if(SAFARI){if("about:blank"==document.location.href)return;if(!b&&window&&window.parent!=window){var d=chrome.extension.getURL("");if(document.location.href.substr(0,d.length)!=d)return}var e=null;if(!safari)return void log.warn("No 'safari' object.");e=safari.application?safari.application:safari.self,c=function(b){b.name&&a[b.name]&&a[b.name](b.message,{tab:b.target},null)},e.addEventListener("message",c,!1)}else c=function(b,c,d){return!c||c.id!==Browser.extensionID&&c.sender&&c.sender.id!==Browser.extensionID?void log.warn("Got request from unexpected sender. Ignoring."):(b.name&&a[b.name]&&a[b.name](b,c,d),!!d||void 0)},chrome.runtime.onMessage?chrome.runtime.onMessage.addListener(c):chrome.extension.onMessage?chrome.extension.onMessage.addListener(c):chrome.extension.onRequest.addListener(c);Browser.messageListeners.push(c)},Browser.addKeyboardHandlers=function(a){for(var b in a)Browser.keyCombos[b]=a[b]},Browser.handleKeys=function(a){var b=[];for(var c in Browser.currentKeys)b.push(parseInt(c));b.sort(function(a,b){return a-b});var d=b.join(" + ");Browser.keyCombos[d]&&Browser.keyCombos[d](d,a),Browser.currentKeys={}},Browser.setIcon=function(a){if(SAFARI)for(var b in safari.extension.toolbarItems){var c=safari.extension.toolbarItems[b];"clipper"==c.identifier&&(c.image=safari.extension.baseURI+a+"-16x16.png")}else chrome.browserAction.setIcon({path:{19:chrome.extension.getURL(a+"-19x19.png"),20:chrome.extension.getURL(a+"-20x20.png"),38:chrome.extension.getURL(a+"-19x19@2x.png"),40:chrome.extension.getURL(a+"-40x40.png")}})},Browser.getExtensionURL=function(a){var a=a||"";return SAFARI?safari.extension.baseURI+a:chrome.extension.getURL(a)},Browser.setTitle=function(a){if(SAFARI)for(var b in safari.extension.toolbarItems){var c=safari.extension.toolbarItems[b];"clipper"==c.identifier&&(c.toolTip=a)}else EDGE||chrome.browserAction.setTitle({title:a})},Browser.setBrowserActionClickHandler=function(a){SAFARI?Browser.safariBrowserActionClickHelper=function(b){if("clipper"==b.command)for(var c=safari.extension.toolbarItems,d=0;d<c.length;d++)if("clipper"==c[d].identifier){a(b.target.browserWindow.activeTab);break}}:chrome.browserAction.onClicked&&(chrome.browserAction.onClicked.hasListener(a)||(Browser.browserActionOnClickedListeners.push(a),chrome.browserAction.onClicked.addListener(a)))},Browser.removeBrowserActionClickHandler=function(a){if(SAFARI)Browser.safariBrowserActionClickHelper=function(){log.log("do nothing on browser action click - removed handler")};else if(chrome.browserAction.onClicked){a||(a=Browser.browserActionOnClickedListeners[0]?Browser.browserActionOnClickedListeners[0]:null);var b=Browser.browserActionOnClickedListeners.indexOf(a);b>-1&&Browser.browserActionOnClickedListeners.splice(b,1),chrome.browserAction.onClicked.removeListener(a)}},Browser.insertJS=function(a,b){SAFARI?(safari.extension.addContentScriptFromURL(safari.extension.baseURI+a),b&&b()):b?chrome.tabs.executeScript(null,{file:a},b):chrome.tabs.executeScript(null,{file:a})},Browser.insertCSS=function(a,b){SAFARI?(safari.extension.addContentStyleSheetFromURL(safari.extension.baseURI+a),b&&b()):b?chrome.tabs.insertCSS(null,{file:a},b):chrome.tabs.insertCSS(null,{file:a})},Browser.captureVisibleTab=function(a,b){SAFARI?a.visibleContentsAsDataURL(b):chrome.tabs.captureVisibleTab(a.windowId,{format:"png"},b)},Browser.getCurrentTab=function(a){SAFARI?a(safari.application.activeBrowserWindow.activeTab):chrome.tabs.query({active:!0,currentWindow:!0},function(b){b&&b.length>0?a(b[0]):(log.warn("chrome tabs query did not return a result while getting current tab"),a())})},Browser.getAllTabs=function(a){if(SAFARI){for(var b=safari.application.browserWindows,c=[],d=0;d<b.length;d++)for(var e=0;e<b[d].tabs.length;e++)c.push(b[d].tabs[e]);a(c)}else chrome.tabs.query({},a)},Browser.setPopup=function(a){SAFARI?""==a.trim()?safari.extension.toolbarItems[0].popover&&(safari.extension.toolbarItems[0].popover.visible?Browser.safariPopoverVisibilityCheckInterval=setInterval(function(){safari.extension.toolbarItems[0].popover?safari.extension.toolbarItems[0].popover.visible||(clearInterval(Browser.safariPopoverVisibilityCheckInterval),safari.extension.toolbarItems[0].popover=null,safari.extension.removePopover("clipper")):clearInterval(Browser.safariPopoverVisibilityCheckInterval)},1500):(safari.extension.toolbarItems[0].popover=null,safari.extension.removePopover("clipper"))):(safari.extension.toolbarItems[0].popover&&(safari.extension.toolbarItems[0].popover.hide(),safari.extension.toolbarItems[0].popover=null),safari.extension.removePopover("clipper"),safari.extension.toolbarItems[0].popover=safari.extension.createPopover("clipper",safari.extension.baseURI+a),Browser.safariBrowserActionClickHelper=function(a){if("clipper"==a.command){safari.extension.toolbarItems;safari.extension.toolbarItems[0].showPopover()}}):chrome.browserAction.setPopup({popup:a})},Browser.overrideScroll=function(a){var b=a.wheelDelta||-a.detail;this.scrollTop+=(b<0?1:-1)*Math.abs(a.wheelDeltaY),a.preventDefault()},window.addEventListener("keydown",function(a){189==a.keyCode&&a.altKey?Browser.currentKeys[76]=a:188==a.keyCode&&a.altKey?Browser.currentKeys[80]=a:190==a.keyCode&&a.altKey?Browser.currentKeys[88]=a:Browser.currentKeys[a.keyCode]=a},!0),window.addEventListener("keyup",function(a){Browser.handleKeys(a.srcElement)}),Browser.runAfterDomLoaded=function(a){var b=document.readyState;"uninitialized"!=b&&"loading"!=b?a():window.addEventListener("DOMContentLoaded",a)},Object.preventExtensions(Browser)}var Browser={};Browser.runIfInTopFrame=function(a){"use strict";SAFARI?a():navigator.userAgent.match(/chrome/i)&&a()},Browser.messageListeners=[],Browser.runIfInTopFrame(initBrowser);