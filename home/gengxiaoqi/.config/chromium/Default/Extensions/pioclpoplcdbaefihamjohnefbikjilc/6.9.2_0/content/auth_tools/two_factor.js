/*! Copyright 2009-2016 Evernote Corporation. All rights reserved. */
function clearError(a){a.className=a.className.replace(/\s*error/g,""),a.nextElementSibling.removeAttribute("data-error")}function goBackToLogin(a){window.location.href=Browser.extension.getURL("content/auth_tools/login.html"+("string"==typeof a?"?globalError="+encodeURIComponent(a):""))}function msgHandlerTwoStepResponse(a,b,c){"INVALID_TWO_STEP_CODE"==a.error?setError(code,Browser.i18n.getMessage("incorrectCode")):"EXPIRED_AUTHENTICATION_TOKEN"==a.error?goBackToLogin(Browser.i18n.getMessage("expiredTwoStepCode")):a.error?log.error("error with two step response: ",+a.error):a.sso?(background.trackEvent({category:"Account",action:"sign_in",label:"sso_needed",data:background.generateUserCustomDimensions()}),window.location.href="content/auth_tools/sso.html?bizName="+encodeURIComponent(a.bizName)):(background.trackEvent({category:"Account",action:"sign_in",label:"completed",data:background.generateUserCustomDimensions()}),Browser.getCurrentTab(function(a){background.toggleClipper({afterAuth:!0},{tab:a}),closePopup()}))}function setError(a,b){a.className+=" error",a.nextElementSibling.setAttribute("data-error",b)}function setupTFa(){explanation.innerText=Browser.i18n.getMessage("gaMessage");for(var a=window.location.search.substr(1).split("&"),b=0;b<a.length;b++){var c=a[b].split("=");switch(c[1]=decodeURIComponent(c[1]),c[0]){case"auth":auth=c[1],help.addEventListener("click",function(){new Date>expiration?goBackToLogin(Browser.i18n.getMessage("expiredTwoStepCode")):(background.msgHandlerOpenTab({url:baseUrl+"/TwoStepHelp.action?auth="+encodeURIComponent(auth)}),closePopup())});break;case"expiration":expiration=c[1];break;case"sms":explanation.innerText=Browser.i18n.getMessage("smsMessage",[c[1].toString()])}}/china/i.test(background.getBootstrapInfo("name"))?logo.className+=" china":logo.className=logo.className.replace(/\s*china/g,"")}function submitCode(){var a=code.value.replace(/-/g,"");new Date>expiration?goBackToLogin(Browser.i18n.getMessage("expiredTwoStepCode")):/^(\d{6}|\d{16})$/.test(a)?background.msgHandlerSubmitTwoStepCode({auth:auth,code:a},null,msgHandlerTwoStepResponse):setError(code,Browser.i18n.getMessage("incorrectCode"))}var logo,closeButton,cancel,explanation,code,continueButton,help,auth,expiration,background=Browser.extension.getBackgroundPage().extension,baseUrl=background.getOption("secureProto")+background.getBootstrapInfo("serviceHost");window.addEventListener("DOMContentLoaded",function(){function a(){GlobalUtils.localize(document.body),code.placeholder=Browser.i18n.getMessage("sixDigitCode")}logo=document.querySelector("#logo"),closeButton=document.querySelector("#close"),cancel=document.querySelector("#cancel"),explanation=document.querySelector("#explanation"),code=document.querySelector("#code"),continueButton=document.querySelector("#continue"),help=document.querySelector("#help"),GlobalUtils.runAsyncIfCondition(EDGE,a,100),errorClickHandler=function(a){var b=a.currentTarget,c=b.style.display;b.style.display="none";var d=document.elementFromPoint(a.clientX,a.clientY);b.style.display=c,clearError(d),d.focus()};for(var b=document.getElementsByClassName("errorHoverRegion"),c=0;c<b.length;c++)b[c].addEventListener("click",errorClickHandler);logo.addEventListener("click",function(){background.msgHandlerOpenTab({url:baseUrl+"/Home.action"})}),closeButton.addEventListener("click",closePopup),closeButton.addEventListener("keypress",function(a){13==a.keyCode&&closePopup()}),cancel.addEventListener("click",goBackToLogin),cancel.addEventListener("keypress",function(a){13==a.keyCode&&goBackToLogin()}),code.addEventListener("keypress",function(a){13==a.keyCode&&submitCode()}),code.addEventListener("input",function(){clearError(code)}),continueButton.addEventListener("click",submitCode),continueButton.addEventListener("keypress",function(a){13==a.keyCode&&submitCode()}),GlobalUtils.runAsyncIfCondition(EDGE,setupTFa,300)});