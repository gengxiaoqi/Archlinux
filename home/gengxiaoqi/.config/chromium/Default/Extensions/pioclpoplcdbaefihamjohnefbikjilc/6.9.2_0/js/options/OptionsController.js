/*! Copyright 2009-2016 Evernote Corporation. All rights reserved. */
function OptionsController(){"use strict";function a(){var a={};for(var b in A)A[b].forEach(function(b){a[b]=!1});Browser.sendToExtension({name:"main_getConfig",options:a,returnName:"options_config"})}function b(a){if(a.options){GlobalUtils.localize(document.body),GlobalUtils.localize(document.getElementsByTagName("title")[0]);for(var b in A)switch(b){case"checkboxValues":A[b].forEach(function(b){var c=b,d=document.getElementById(c);d.checked=a.options[c],"enableKeyboardShortcuts"==c&&(d.checked||document.getElementById("shortcutsContainer").classList.add("disabled")),d.addEventListener("change",e)});break;case"selectValues":A[b].forEach(function(b){for(var c=b,d=document.getElementById(c),e=a.options[c],g=0;g<d.options.length;g++)if(d.options[g].value==e){d.selectedIndex=g;break}d.addEventListener("change",f)});break;case"textValues":A[b].forEach(function(b){var c=b,d=document.getElementById(c);d.value=a.options[c],d.addEventListener("change",g)});break;case"boxValues":A[b].forEach(function(b){var c=b;"startNotebook"===c&&E&&(K=a.options[c],Browser.sendToExtension({name:"getNotebooks",page:"op"}))});break;case"radioValues":A[b].forEach(function(b){var c=b;"notebookSelection"===c&&"smartFiling"===a.options[c]&&E&&E.bizAuthenticationToken&&(document.getElementById("bizSmartFilingCheckbox").style.display="block");for(var d=document.getElementsByName(c),e=0;e<d.length;e++)d.item(e).value==a.options[c]&&(d.item(e).checked=!0),d.item(e).addEventListener("change",i)})}d(a),m()}}function c(a,b,c){var e=[],f=[],g=[];for(var h in a.options)a.options[h]!==B[h]&&(e.push(B[h]),f.push(a.options[h]),g.push(h));d(a),Browser.sendToExtension({name:"bounceToAll",message:{name:"updateKeyboardShortcut",oldShortcut:e,shortcut:f,shortcutName:g}})}function d(a){B={},C={},D={},A.shortcutValues.forEach(function(b){var c=b,d=document.getElementById(c);B[c]=a.options[c],C[a.options[c]]=c;var e=new ShortcutSetter(d,a.options[c],"optionsPage",function(a,b){var c=a.id;if(C[b])return C[b]!=c&&(x=D[C[b]],x.showConflict(),{conflict:!0});if(/(\||^)27(\||$)/.test(b)&&"closeWebClipperShortcut"!==c)return{noEsc:!0};j();var d={};return d[c]=b,console.log("Sending options change:"),console.log(d),Browser.sendToExtension({name:"main_setOption",options:d}),Browser.sendToExtension({name:"bounceToAll",message:{name:"updateKeyboardShortcut",oldShortcut:B[c],shortcut:b,shortcutName:c}}),delete C[B[c]],C[b]=c,B[c]=b,!1},function(){return!!v||(v=!0,!1)},function(){x&&(x.removeConflict(),x=null)},function(){return document.getElementById("shortcutsContainer").classList.contains("disabled")},function(a){return z[a]});D[c]=e})}function e(a){var b=this.id;if(b){j();var c={};c[b]=this.checked,"enableKeyboardShortcuts"==b&&(this.checked?document.getElementById("shortcutsContainer").classList.remove("disabled"):document.getElementById("shortcutsContainer").classList.add("disabled"),Browser.sendToExtension({name:"bounceToAll",message:{name:"receiveKeyboardShortcutsEnabled",keyboardShortcutsEnabled:this.checked}})),Browser.sendToExtension({name:"main_setOption",options:c})}m()}function f(a){var b=this.id;if(b){j();var c={};if("startNotebook"===b){var d=document.getElementById("startNotebookList").querySelector("div[selected=true]");c[b]=d.getAttribute("guid")}else c[b]=this.options[this.selectedIndex].value;Browser.sendToExtension({name:"main_setOption",options:c})}m()}function g(a){var b=this.id;if(b){j();var c={};c[b]=this.value,console.log("Sending options change:"),console.log(c),Browser.sendToExtension({name:"main_setOption",options:c})}m()}function h(a){var b=a.id;if(b){j();var c={};"startNotebook"===b?c[b]=a.getAttribute("guid"):c[b]=a.innerHTML,console.log("Sending options change:"),console.log(c),Browser.sendToExtension({name:"main_setOption",options:c})}m()}function i(){var a=this.name;if(a){j();var b={};b[a]=this.value,"notebookSelection"==a&&("smartFiling"===this.value&&E&&E.bizAuthenticationToken?document.getElementById("bizSmartFilingCheckbox").style.display="block":(document.getElementById("bizSmartFilingCheckbox").style.display="","alwaysStartIn"===this.value&&f.call(document.getElementById("startNotebook")))),Browser.sendToExtension({name:"main_setOption",options:b})}m()}function j(){window.setTimeout(function(){document.querySelector("#savingContainer").className="invisible"},500),document.querySelector("#savingContainer").className="visible"}function k(a){event.keyCode==G[H]?H++:H=0,H==G.length&&(H=0,"none"==document.getElementById(I).style.display?document.getElementById(I).style.display="table-row-group":document.getElementById(I).style.display="none",m())}function l(b){b&&b.auth&&(E=b.auth,F=b.saveToEvernote,document.body.classList.add("loggedIn"),document.getElementById("username").innerText=E.email,F&&(document.getElementById("options_showSaveToEvernote").style.display="table-row")),a()}function m(){var a=document.getElementById("optionsContainer"),b=a.scrollHeight;document.getElementsByClassName("pinch")[0].style.height=b+"px",Browser.sendToExtension({name:"bounce",message:{name:"setOptionsHeight",height:266+b}})}function n(a,b){w&&["INPUT","TEXTAREA"].indexOf(b.nodeName)<0&&"true"!==b.contentEditable&&Browser.sendToExtension({name:"bounce",message:{name:"duplicateKeyboardShortcut",keycode:a}})}function o(a,b){["INPUT","TEXTAREA"].indexOf(b.nodeName)<0&&"true"!==b.contentEditable&&Browser.sendToExtension({name:"bounce",message:{name:"duplicateKeyboardShortcut",keycode:a}})}function p(a,b,c){"charCodeCache"==a.key?(z=a.value||{},Browser.sendToExtension({name:"main_isAuthenticated",type:"options"})):"isDevelopOptionsEnable"===a.key&&"true"===a.value&&("none"==document.getElementById(I).style.display?document.getElementById(I).style.display="table-row-group":document.getElementById(I).style.display="none",Browser.sendToExtension({name:"setPersistentValue",key:"isDevelopOptionsEnable",value:"false"}),m())}function q(){var a={name:"bounceToAll",message:{name:"hideOptions",authed:!1}};if(EDGE){var b=function(){Browser.sendToExtension({name:"main_restart"})};Browser.sendToExtension(a,b)}else Browser.sendToExtension(a),Browser.sendToExtension({name:"main_restart"})}function r(a,b,c){if(w=a.enabled,a.handlers){var d={};for(var e in a.handlers)for(var f=0;f<a.handlers[e].length;f++)"closeWebClipperShortcut"===e?d[a.handlers[e][f]]=o:d[a.handlers[e][f]]=n;Browser.addKeyboardHandlers(d)}}function s(a,b,c){document.getElementsByClassName("pinch")[0].style.height=a.totalHeight-266+"px"}function t(a,b,c){function d(a){return"DIV"===a.nodeName?a.innerText:"DIV"===a.nodeName?a.innerText:void 0}var e=document.getElementById("startNotebook"),f=document.getElementById("startNotebookList");e.addEventListener("click",function(a){u(),a.stopPropagation()}),document.getElementById("main").addEventListener("click",function(a){document.getElementById("startNotebookList").classList.contains("opened")&&u()});for(var g=0;g<a.notebooks.length;g++){var i=document.createElement("div");i.title=a.notebooks[g].name,i.innerHTML=a.notebooks[g].name,a.notebooks[g].owner&&(i.innerHTML=a.notebooks[g].name+" ("+a.notebooks[g].owner+")"),i.setAttribute("guid",a.notebooks[g].guid),a.notebooks[g].stack?(J[a.notebooks[g].stack]||(J[a.notebooks[g].stack]=document.createElement("div"),J[a.notebooks[g].stack].classList.add("optgroup"),J[a.notebooks[g].stack].label=a.notebooks[g].stack,CommonSelector.binaryInsert(startNotebookList,d,J[a.notebooks[g].stack])),CommonSelector.binaryInsert(J[a.notebooks[g].stack],d,i)):CommonSelector.binaryInsert(startNotebookList,d,i),a.notebooks[g].defaultNotebook&&(L=i),K&&K===a.notebooks[g].guid&&(i.setAttribute("selected",!0),e.setAttribute("guid",K),e.innerHTML=i.innerText,M=!0),i.addEventListener("click",function(){e.innerHTML=this.innerText;for(var a=f.querySelectorAll("div[selected=true]"),b=0,c=a.length;b<c;b++)a[b].setAttribute("selected",!1);this.setAttribute("selected",!0),e.setAttribute("guid",this.getAttribute("guid")),h(e),u()}),i.addEventListener("mouseover",function(){for(var a=f.querySelectorAll(".nbHover"),b=0;b<a.length;b++)a[b].classList.remove("nbHover");this.classList.add("nbHover")})}L&&!M&&(e.innerHTML=L.innerText,e.setAttribute("guid",L.getAttribute("guid")),L.setAttribute("selected",!0))}function u(){var a=document.getElementById("startNotebookList");if(a.classList.toggle("opened"),a.classList.contains("opened")){var b=document.querySelector("div[selected=true]");a.focus(),setTimeout(function(){b.scrollIntoViewIfNeeded?b.scrollIntoViewIfNeeded():b.scrollIntoView()},50)}}var v=!1,w=!0;window.addEventListener("DOMContentLoaded",function(){document.getElementById("signOut").addEventListener("click",function(){Browser.sendToExtension({name:"LOGOUT"}),Browser.sendToExtension({name:"trackEvent",category:"Account",action:"sign_out",endSession:!0})}),document.getElementById("resetShortcuts").addEventListener("click",function(){j(),Browser.sendToExtension({name:"main_clearOptions",options:A,type:"shortcutValues"})}),document.getElementById("resetAllOptions").addEventListener("click",function(){confirm("Warning. This action will delete all persistent clipper data on this browser.")===!0?(log.log("Reset all options"),j(),log.log("Clean all local storage"),Persistent.clearAll(),Browser.sendToExtension({name:"clearPersistent"}),Browser.sendToExtension({name:"main_clearOptions",options:A,type:"all"}),Browser.sendToExtension({name:"LOGOUT"})):log.log("Cancel to reset all options")}),document.getElementById("done").addEventListener("click",function(){Browser.sendToExtension({name:"bounce",message:{name:"hideOptions",authed:!!E}})}),EDGE&&document.getElementById("main").classList.add("isEdge"),Browser.sendToExtension({name:"getPersistentValue",key:"charCodeCache"}),Browser.sendToExtension({name:"getPersistentValue",key:"isDevelopOptionsEnable"})}),Browser.addMessageHandlers({logoutCallback:q,options_config:b,options_isAuthenticated:l,optionsShortcutCleared:c,op_receivePersonalNotebooks:t,op_receiveSharedNotebooks:t,op_receiveBusinessNotebooks:t,op_setKeyboardHandlers:r,op_setPinchHeight:s,receivePersistentValue:p});var x,y,z,A={checkboxValues:["smartFilingTags","alwaysTagWith","useSearchHelper","enablePdfPageButton","saveToEvernote","simulateSimplifiedChinese","useStage","enableKeyboardShortcuts","bizSmartFilingEnabled"],selectValues:["clipAction"],boxValues:["startNotebook"],textValues:["alwaysTags","insecureProto","secureProto","overrideServiceURL"],radioValues:["notebookSelection","defaultClipAction","afterClip","simulateClippingError"],shortcutValues:["startWebClipperShortcut","closeWebClipperShortcut","previewArticleShortcut","previewFullPageShortcut","previewUrlShortcut","selectionModeShortcut","takeScreenshotShortcut","clearlyShortcut","pdfShortcut","emailShortcut","expandArticleShortcut","contractArticleShortcut","moveArticleUpShortcut","moveArticleDownShortcut","selectNotebookShortcut","addTagsShortcut","saveShortcut","minimizeClipperShortcut","selectAllMarkupShortcut","arrowShortcut","textShortcut","rectangleShortcut","roundedRectangleShortcut","ellipseShortcut","lineShortcut","markerShortcut","highlighterShortcut","stampShortcut","pixelateShortcut","cropShortcut","zoomInShortcut","zoomOutShortcut","zoomToFitShortcut","zoomToOriginalShortcut","undoShortcut","redoShortcut"]},B={},C={},D={},E=null,F=!1;window.addEventListener("keydown",function(a){z&&(a.keyCode<65||a.keyCode>90)&&(y=a.keyCode)},!0),window.addEventListener("keypress",function(a){z&&y&&(y!=a.charCode&&(z[y]=a.charCode,Browser.sendToExtension({name:"setPersistentValue",key:"charCodeCache",value:z})),y=null)}),window.addEventListener("keydown",k);var G=[38,38,40,40,37,39,37,39,66,65],H=0,I="developerContainer",J={},K=null,L=null,M=!1;Object.preventExtensions(this)}Object.preventExtensions(OptionsController);var optionsController=new OptionsController;window.addEventListener("DOMContentLoaded",function(){function a(a){if(a.bootstrapInfo&&a.bootstrapInfo.name){a.bootstrapInfo.name.match(/china/i)&&document.body.classList.add("china");var b="https://"+a.bootstrapInfo.serviceHost;document.getElementById("copyright").innerHTML=Browser.i18n.getMessage("copyright",[(new Date).getFullYear().toString(),b]),document.getElementById("logDescription").innerHTML=Browser.i18n.getMessage("options_eventLogDescription",[b+"/privacy"]);for(var c=document.getElementsByClassName("tab"),d=0;d<c.length;d++)c.item(d).addEventListener("click",function(){var a=document.querySelector(".tab.pressed");a&&(a.className=a.className.replace(/\s*pressed/g,""));var b=document.querySelector(".pinch");b.className=b.className.replace(/\s*(options|shortcuts|legal)/g,""),this.className+=" pressed","optionsTab"==this.id?b.className+=" options":"shortcutsTab"==this.id?b.className+=" shortcuts":"legalTab"==this.id&&(b.className+=" legal")});/shortcuts/.test(document.location.hash)&&document.getElementById("shortcutsTab").click()}}function b(a,b,c){"EVERNOTE_VERSION"==a.key&&(document.getElementById("version").innerText=a.value+" ("+BUILD_VERSION+"/"+SKITCH_BUILD_VERSION+")")}SAFARI&&document.body.classList.add("safari"),/iframe/.test(document.location.hash)&&document.body.classList.add("iframe"),Browser.addMessageHandlers({options_config:a,receivePersistentValue:b}),Browser.sendToExtension({name:"main_getConfig",bootstrapInfo:{name:null,serviceHost:null},returnName:"options_config"}),Browser.sendToExtension({name:"getPersistentValue",key:"EVERNOTE_VERSION"})}),window.addEventListener("error",function(a){log.error(JSON.stringify(a))});