/*! Copyright 2009-2016 Evernote Corporation. All rights reserved. */
function checkEmail(){if(validateEmail()){var a=new XMLHttpRequest;a.open("GET",baseUrl+"/RegistrationCheck.action?email="+encodeURIComponent(email.value)+"&checkEmail=true",!0),a.onreadystatechange=function(){4==a.readyState&&(200==a.status?markValid(email):400==a.status?setError(email,Browser.i18n.getMessage("regForm_invalid_email")):409==a.status?setError(email,Browser.i18n.getMessage("regForm_taken_email")):500==a.status?setError(email,Browser.i18n.getMessage("EDAMError_1")):0===a.status&&log.warn("no network connection while checking email uniqueness in registration screen"),handleCheckTextSize(email))},a.send()}}function checkPassword(){validatePassword()&&markValid(password)}function checkUsername(){if(validateUsername()){var a=new XMLHttpRequest;a.open("GET",baseUrl+"/RegistrationCheck.action?username="+encodeURIComponent(username.value)+"&checkUsername=true",!0),a.onreadystatechange=function(){4==a.readyState&&(200==a.status?markValid(username):400==a.status?setError(username,Browser.i18n.getMessage("regForm_invalid_username")):409==a.status?setError(username,Browser.i18n.getMessage("regForm_taken_username")):412==a.status?setError(username,Browser.i18n.getMessage("regForm_deactivated_username",[baseUrl+"/AccountReactivation.action"])):500==a.status?setError(username,Browser.i18n.getMessage("EDAMError_1")):0===a.status&&log.warn("no network connection while checking username uniqueness in registration screen"),handleCheckTextSize(username))},a.send()}}function clearError(a){a.className=a.className.replace(/\s*error/g,""),a.nextElementSibling.removeAttribute("data-error")}function clearValid(a){a.className=a.className.replace(/\s*valid/g,"")}function goBackToLogin(){window.location.href=Browser.extension.getURL("content/auth_tools/login.html")}function markValid(a){a.className+=" valid"}function msgHandlerLoginResponse(a,b,c){Browser.getCurrentTab(function(a){background.toggleClipper({afterAuth:!0},{tab:a}),closePopup()})}function msgHandlerRefreshCaptcha(a,b,c){captchaImg.src=baseUrl+a.captcha,submit=a.submit}function register(){var a=validateEmail(),b=validateUsername(),c=validatePassword(),d=!captchaNeeded|validateCaptcha();if(a&&b&&c&&d){var e="clipper_chr";SAFARI?e="clipper_saf":OPERA?e="clipper_op":YANDEX?e="clipper_yan":EDGE&&(e="clipper_edg");var f=new FormData;f.append("email",email.value),f.append("username",username.value),f.append("password",password.value),f.append("captcha",captcha.value),f.append("code",e),f.append("terms",!0),f.append("create",!0);var g=new XMLHttpRequest;g.open("POST",baseUrl+submit,!0),g.onreadystatechange=function(){if(4==g.readyState&&200==g.status){var a=JSON.parse(g.response);if(a.success)background.msgHandlerLogin({username:username.value,password:password.value,useSearchHelper:background.getOption("useSearchHelper")},null,msgHandlerLoginResponse),background.trackEvent({category:"Account",action:"registration",label:"completed"});else{for(var b=0;b<a.errors.length;b++){var c=a.errors[b];"captcha"==c["field-name"]&&("registrationAction.captia"==c.code&&(captchaNeeded=!0,captchaContainer.classList.remove("hide"),registerButton.classList.add("showCaptcha")),background.msgHandlerGetRegistrationLinks(null,null,msgHandlerRefreshCaptcha),setError(captcha,Browser.i18n.getMessage("regForm_invalid_captcha")))}handleCheckTextSize(email),handleCheckTextSize(username),handleCheckTextSize(captcha)}}else 0===g.status?log.error("error registering: network failure"):4==g.readyState&&log.error("error registering: "+g.status)},g.send(f)}}function registerFromKeyboard(a){13==a.keyCode&&register()}function setError(a,b){a.className+=" error",a.nextElementSibling.setAttribute("data-error",b)}function setupReg(){/china/i.test(background.getBootstrapInfo("name"))?(logo.className+=" china",leftLogo&&(leftLogo.className+=" china")):(logo.className=logo.className.replace(/\s*china/g,""),leftLogo&&(leftLogo.className=leftLogo.className.replace(/s*china/g,""))),legal.innerHTML=Browser.i18n.getMessage("registration_terms",[baseUrl+"/tos",baseUrl+"/privacy"]);for(var a=window.location.search.substr(1).split("&"),b=0;b<a.length;b++){var c=a[b].split("=");c[1]=decodeURIComponent(c[1]),"captcha"==c[0]?captchaImg.src=baseUrl+c[1]:"submit"==c[0]&&(submit=c[1])}}function validateCaptcha(){return 0===captcha.value.length&&setError(captcha,Browser.i18n.getMessage("regForm_invalid_captcha")),handleCheckTextSize(captcha),0!==captcha.value.length}function validateEmail(){var a=email.value.length>30?SIMPLE_MAIL_REGEX:ADVANCED_MAIL_REGEX;return 0===email.value.length?setError(email,Browser.i18n.getMessage("regForm_email_required")):a.test(email.value)||setError(email,Browser.i18n.getMessage("regForm_invalid_email")),handleCheckTextSize(email),0!==email.value.length&&a.test(email.value)}function validatePassword(){var a=new RegExp("^[A-Za-z0-9!#$%&'()*+,./:;<=>?@^_`{|}~\\[\\]\\\\-]{6,64}$");return 0===password.value.length?(setError(password,Browser.i18n.getMessage("regForm_password_required")),!1):!!a.test(password.value)||(setError(password,Browser.i18n.getMessage("regForm_invalid_password")),!1)}function validateUsername(){var a=new RegExp("^[a-z0-9]([a-z0-9_-]{0,62}[a-z0-9])?$");return a.test(username.value)||setError(username,Browser.i18n.getMessage("regForm_invalid_username")),handleCheckTextSize(username),a.test(username.value)}function updateTempElText(a){autoResizeElement.textContent=a.value,""===autoResizeElement.textContent&&a.placeholder&&(autoResizeElement.textContent=a.placeholder);var b=window.getComputedStyle(a,null);document.getElementById("tempDiv").setAttribute("style","font: "+b.getPropertyValue("font"))}function getTextWidth(a){var b=window.getComputedStyle(a,null),c=a.offsetWidth,d=b.getPropertyValue("padding-left").replace("px",""),e=b.getPropertyValue("padding-right").replace("px",""),f=b.getPropertyValue("border-left-width").replace("px",""),g=b.getPropertyValue("border-right-width").replace("px","");return c-d-e-f-g}function handleCheckTextSize(a){updateTempElText(a);var b=getTextWidth(a),c=getTextWidth(autoResizeElement),d=parseFloat(window.getComputedStyle(a,null).getPropertyValue("font-size"));if(!(d==minFontSize&&b<=c||d==maxFontSize&&b>=c)){var e=d,f=b>=c?1:-1;do{if(e+=f,document.getElementById("tempDiv").style.fontSize=e+"px",c=getTextWidth(autoResizeElement),1==f){if(!(c<b))break;d=e}if(f==-1&&(d=e,c<=b))break}while(e>minFontSize&&e<maxFontSize);a.style.fontSize=d+"px"}}function createAutoResizeElement(){var a=document.createElement("div");a.id="tempDiv",autoResizeElement=document.createElement("span"),autoResizeElement.style.position="absolute",autoResizeElement.style.whiteSpace="nowrap",autoResizeElement.style.left="-9999px",a.appendChild(autoResizeElement),document.body.appendChild(a)}var logo,leftLogo,closeButton,cancel,email,username,password,captcha,captchaContainer,captchaImg,registerButton,legal,autoResizeElement,maxFontSize=14,minFontSize=11,captchaNeeded=!1,submit,usernameCheckTimeout,background=Browser.extension.getBackgroundPage().extension,baseUrl=background.getOption("secureProto")+background.getBootstrapInfo("serviceHost"),SIMPLE_MAIL_REGEX=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i,ADVANCED_MAIL_REGEX=new RegExp("^[A-Za-z0-9!#$%&'*+/=?^_`{|}~-]+(.[A-Za-z0-9!#$%&'*+/=?^_`{|}~-]+)*@[A-Za-z0-9-]+(.[A-Za-z0-9-]+)*.([A-Za-z]{2,})$");window.addEventListener("DOMContentLoaded",function(){function a(){GlobalUtils.localize(document.body),email.placeholder=Browser.i18n.getMessage("email"),username.placeholder=Browser.i18n.getMessage("registrationForm_username"),password.placeholder=Browser.i18n.getMessage("loginForm_password"),captcha.placeholder=Browser.i18n.getMessage("captcha_instruction"),handleCheckTextSize(email),handleCheckTextSize(username),handleCheckTextSize(captcha)}logo=document.querySelector("#logo"),leftLogo=document.querySelector("#left .inner .top"),closeButton=document.querySelector("#close"),cancel=document.querySelector("#cancel"),email=document.querySelector("#email"),username=document.querySelector("#username"),password=document.querySelector("#password"),captchaContainer=document.querySelector("#captchaContainer"),captcha=document.querySelector("#captcha"),captchaImg=document.querySelector("#captchaContainer img"),registerButton=document.querySelector("#register"),legal=document.querySelector("#legal"),createAutoResizeElement(),GlobalUtils.runAsyncIfCondition(EDGE,a,300),errorClickHandler=function(a){var b=a.currentTarget,c=b.style.display;b.style.display="none";var d=document.elementFromPoint(a.clientX,a.clientY);b.style.display=c,clearError(d),d.focus()};for(var b=document.getElementsByClassName("errorHoverRegion"),c=0;c<b.length;c++)b[c].addEventListener("click",errorClickHandler);logo.addEventListener("click",function(){background.msgHandlerOpenTab({url:baseUrl+"/Home.action"}),closePopup()}),closeButton.addEventListener("click",closePopup),closeButton.addEventListener("keypress",function(a){13==a.keyCode&&closePopup()}),cancel.addEventListener("click",goBackToLogin),cancel.addEventListener("keypress",function(a){13==a.keyCode&&goBackToLogin()}),email.addEventListener("blur",checkEmail),email.addEventListener("input",function(){clearError(email),clearValid(email),handleCheckTextSize(email)}),email.addEventListener("keypress",registerFromKeyboard),username.addEventListener("input",function(){clearTimeout(usernameCheckTimeout),clearError(username),clearValid(username),usernameCheckTimeout=setTimeout(checkUsername,800),handleCheckTextSize(username)}),username.addEventListener("blur",function(){clearTimeout(usernameCheckTimeout),checkUsername()}),username.addEventListener("keypress",registerFromKeyboard),password.addEventListener("input",function(){clearError(password),clearValid(password)}),password.addEventListener("blur",checkPassword),password.addEventListener("keypress",registerFromKeyboard),captcha.addEventListener("input",function(){clearError(captcha),handleCheckTextSize(captcha)}),captcha.addEventListener("blur",validateCaptcha),captcha.addEventListener("keypress",registerFromKeyboard),registerButton.addEventListener("click",register),registerButton.addEventListener("keypress",registerFromKeyboard),legal.addEventListener("click",function(a){"A"==a.srcElement.nodeName&&(a.preventDefault(),background.msgHandlerOpenTab({url:a.srcElement.href}),closePopup())}),GlobalUtils.runAsyncIfCondition(EDGE,setupReg,300),background.trackEvent({category:"Account",action:"registration",label:"started"})});