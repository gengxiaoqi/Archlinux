/*
 Copyright (c) 2012 Amazon.com, Inc. All rights reserved.         *
*/
(function(){var b=window.$SendToKindle={REF_FIRST_TIME:"stk_gch_ft",CONTENT_EXPIRY_TIMESPAN:2592E6,CONTENT_RENEW_TIMESPAN:6E5,CLEANUP_TIMESPAN:6E5,EXTENSION_ID:void 0,TX_READ_ONLY:"readonly",TX_READ_WRITE:"readwrite",bootstrap:function(){b.EXTENSION_ID=chrome.i18n.getMessage("@@extension_id");b.modernize();b.checkFirstRun();b.updateLowQualityAction();b.registerEvents();setTimeout(b.cleanStorage,b.CLEANUP_TIMESPAN)},modernize:function(){window.indexedDB||(window.indexedDB=window.webkitIndexedDB,window.IDBKeyRange=
window.webkitIDBKeyRange,b.TX_READ_ONLY=window.webkitIDBTransaction.READ_ONLY,b.TX_READ_WRITE=window.webkitIDBTransaction.READ_WRITE)},checkFirstRun:function(){var a=chrome.app.getDetails();void 0===window.localStorage.version&&(b.checkSetupStatus(),chrome.storage.sync.set({"s2k-send-shortcut":{control:!1,shift:!1,alt:!0,key:75}}),chrome.storage.sync.set({"s2k-preview-shortcut":{control:!1,shift:!1,alt:!0,key:80}}));window.localStorage.version=a.version},checkSetupStatus:function(){var a=new XMLHttpRequest;
a.open("GET",chrome.i18n.getMessage("serviceUrl")+"?action\x3dstatus",!0);a.onload=function(a){a=JSON.parse(a.currentTarget.response);(!0===a.setupRequired||!0===a.authRequired&&void 0===window.localStorage["s2k-guid"])&&chrome.tabs.create({url:chrome.i18n.getMessage("setupUrl")+"/ref\x3d"+b.REF_FIRST_TIME})};a.send()},updateLowQualityAction:function(a){var b=new XMLHttpRequest;b.open("GET",chrome.i18n.getMessage("serviceUrl")+"?action\x3dengine",!0);b.onload=function(b){b=JSON.parse(b.currentTarget.response);
window.localStorage.lowQualityAction=b.action||window.localStorage.lowQualityAction||"SEND";void 0!==a&&a()};b.send()},registerEvents:function(){chrome.extension.onRequest.addListener(b.onScriptMessage)},openStorage:function(a){var c=indexedDB.open("s2kwdb",1);c.onerror=function(){a(null)};c.onsuccess=function(){a(c.result)};c.onupgradeneeded=function(a){b.initializeStorage(a.target.result)}},initializeStorage:function(a){a.createObjectStore("sendtokindle",{keyPath:"token"}).createIndex("s2k_idx_urls",
"url",{unique:!1})},containsContent:function(a,c){b.openStorage(function(e){if(null!==e&&c)if(a.token)c(a.token);else{e=e.transaction(["sendtokindle"],b.TX_READ_WRITE).objectStore("sendtokindle");var d=Date.now();e.index("s2k_idx_urls").openCursor(IDBKeyRange.only(a.url)).onsuccess=function(a){if(a=a.target.result)if(d-a.value.timestamp<b.CONTENT_RENEW_TIMESPAN)c(a.primaryKey);else a["continue"]();else c(null)}}else c&&c(null)})},fetchContent:function(a,c){b.openStorage(function(e){if(null!==e&&c){var d=
e.transaction(["sendtokindle"],b.TX_READ_ONLY).objectStore("sendtokindle").get(parseInt(a,10));d.onerror=function(){c({token:a,timestamp:a,data:null})};d.onsuccess=function(){c({token:a,timestamp:d.result?d.result.timestamp:a,data:d.result||null})}}else c&&c(null)})},storeContent:function(a,c){b.containsContent(a,function(e){b.openStorage(function(d){if(null!==d&&c){d=d.transaction(["sendtokindle"],b.TX_READ_WRITE);var f=d.objectStore("sendtokindle");a.token=e||Date.now();a.timestamp=Date.now();d.oncomplete=
function(){void 0!==c&&c(a.token)};f.put(a)}else c&&c(null)})})},cleanStorage:function(){b.openStorage(function(a){a=a.transaction(["sendtokindle"],b.TX_READ_WRITE).objectStore("sendtokindle");var c=Date.now();a.openCursor().onsuccess=function(a){if(a=a.target.result){if(a.value.timestamp+b.CONTENT_EXPIRY_TIMESPAN<c)a["delete"]();a["continue"]()}}});setTimeout(b.cleanStorage,b.CLEANUP_TIMESPAN)},injectLogic:function(a){chrome.tabs.getSelected(null,function(c){c&&!1===/((chrome|chrome-extension):\/\/)|(https:\/\/chrome\.google\.com\/webstore)/i.test(c.url)?
(chrome.tabs.executeScript(null,{file:"content/send-to-kindle-libraries.js"}),chrome.tabs.executeScript(null,{file:"content/send-to-kindle-logic.js"}),chrome.tabs.executeScript(null,{code:"function s2k_inject() {     if(window.$SendToKindle !\x3d\x3d undefined \x26\x26 window.$SendToKindle.isInjected !\x3d\x3d true) {        window.$SendToKindle.Service.prototype.SERVICE_URL \x3d '"+chrome.i18n.getMessage("serviceUrl")+"';        window.$SendToKindle.platformInfo \x3d {'name': 'chrome_ocs', 'version': '1.0.1.74', 'versionId': 74, 'platform': 'chrome-1.0.1.74', 'ref': 'gch'};        window.$SendToKindle.extensionUrl \x3d 'chrome-extension://"+
b.EXTENSION_ID+"/content';        window.$SendToKindle.lowQualityAction \x3d '"+window.localStorage.lowQualityAction+"';        window.$SendToKindle.s2kGuid \x3d '"+window.localStorage.s2kGuid+"';        window.$SendToKindle.isInjected \x3d true;    }    else {        setTimeout(s2k_inject, 500);    }}s2k_inject();"}),void 0!==a&&a()):chrome.tabs.create({url:"http://www.google.com"},function(c){b.injectLogic(a)})})},extractContent:function(a,c,e){chrome.tabs.getSelected(null,function(d){d&&(-1===
d.url.indexOf("chrome://")&&-1===d.url.indexOf("chrome-extension://"))&&(chrome.tabs.executeScript(null,{code:"function s2k_launch() {     if(window.$SendToKindle !\x3d\x3d undefined \x26\x26 window.$SendToKindle.isInjected \x3d\x3d\x3d true \x26\x26 window.$SendToKindle.launch !\x3d\x3d undefined) {        window.$SendToKindle.launch("+a+", "+c+", "+e+");    }    else {        setTimeout(s2k_launch, 500);    }}s2k_launch();"}),b.updateLowQualityAction(function(){chrome.tabs.executeScript(null,{code:"if(window.$SendToKindle !\x3d\x3d undefined) {   window.$SendToKindle.lowQualityAction \x3d '"+
window.localStorage.lowQualityAction+"';}"})}))})},refreshGuid:function(a,c){var e=new XMLHttpRequest;e.open("GET",chrome.i18n.getMessage("serviceUrl")+"?action\x3drefresh-guid",!0);e.onload=function(d){d=JSON.parse(d.currentTarget.response);!0===d.status&&void 0!==d.s2kGuid&&(window.localStorage.s2kGuid=d.s2kGuid);void 0!==a&&void 0!==c&&b.pushMetadata(a,c)};e.send()},pushMetadata:function(a,c){a.data={url:"chrome-extension://"+b.EXTENSION_ID+"/content",s2kGuid:window.localStorage.s2kGuid};c(a)},
onScriptMessage:function(a,c,e){if("fetch-document"===a.action)b.fetchContent(a.data.token,function(b){a.data=b;e(a)});else if("store-content"===a.action)b.storeContent(a.data.content,function(b){var c=chrome.i18n.getMessage(a.data.setup?"setupUrl":"previewUrl")+"?article\x3d"+b+(a.data.send?"\x26send\x3d1":"")+(a.data.auth?"\x26refresh\x3d1":"");e({token:b,url:c})});else if("update-document"===a.action)b.fetchContent(a.data.token,function(c){null!==c&&(c.data.title=a.data.title||c.title,c.data.author=
a.data.author||null,b.storeContent(c.data,function(){}))});else if("shortcut"===a.action){var d=a.shortcut,f=null;chrome.storage.sync.get(["s2k-send-shortcut","s2k-preview-shortcut"],function(a){var c=[];c.push({shortcut:a["s2k-send-shortcut"],action:function(){b.injectLogic(function(){b.extractContent(!1,!1,!0)})}});for(c.push({shortcut:a["s2k-preview-shortcut"],action:function(){b.injectLogic(function(){b.extractContent(!0,!1,!0)})}});void 0!==(f=c.pop());)if(a=f.shortcut,a.key===d.key&&a.control===
d.control&&a.alt===d.alt&&a.shift===d.shift){f.action();break}})}else"extension-metadata"===a.action?!0===a.data.refresh?b.refreshGuid(a,e):b.pushMetadata(a,e):"check-guid"===a.action?b.refreshGuid():"inject"===a.action?b.injectLogic(function(){a.action="inject-done";e(a)}):"extract"===a.action&&b.injectLogic(function(){b.extractContent(a.preview,a.selected,!1)})}};b.bootstrap()})();